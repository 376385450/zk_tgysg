package com.sinohealth.system.dto.application;

import com.sinohealth.common.constant.CommonConstants;
import com.sinohealth.system.biz.application.util.ApplicationSqlBuilder;
import com.sinohealth.system.domain.TgTemplateInfo;
import com.sinohealth.system.domain.converter.JsonBeanConverter;
import com.sinohealth.system.service.impl.TableInfoServiceImpl;
import lombok.extern.slf4j.Slf4j;
import org.junit.Test;

import java.util.concurrent.atomic.AtomicReference;

/**
 * @author kuangchengping@sinohealth.cn
 * 2022-11-22 14:19
 */
@Slf4j
public class ApplicationSqlBuilderTest {

    @Test
    public void testNested() throws Exception {
        String dataRange = "{\"filters\": [{\"id\": \"1\", \"filters\": [{\"isFather\": 1, \"filterItem\": {\"id\": \"Kt3X1669086456695\", \"andOr\": \"and\", \"value\": \"P001\", \"fieldId\": 676, \"filters\": [{\"id\": \"GrpN1669086558371\", \"filters\": [{\"isFather\": 1, \"filterItem\": {\"id\": \"ZTTR1669086558371\", \"andOr\": \"or\", \"value\": \"P001\", \"fieldId\": 676, \"filters\": [{\"id\": \"RMw41669086566986\", \"filters\": [{\"filterItem\": {\"id\": \"PKe61669086566986\", \"andOr\": \"and\", \"value\": \"P001\", \"fieldId\": 676, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"K38p1669086566986\", \"andOr\": \"and\", \"value\": \"维生素矿物质补充剂\", \"fieldId\": 698, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"GSGM1669086597497\", \"andOr\": \"and\", \"value\": \"硒维康口服液\", \"fieldId\": 682, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"2CTi1669089014648\", \"andOr\": \"and\", \"value\": \"Rx\", \"fieldId\": 678, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"notEqualTo\"}}], \"fatherId\": \"ZTTR1669086558371\", \"logicalOperator\": \"and\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"isFather\": 1, \"filterItem\": {\"id\": \"3kX81669086558371\", \"andOr\": \"or\", \"value\": \"P009\", \"fieldId\": 676, \"filters\": [{\"id\": \"mCiQ1669086662773\", \"filters\": [{\"filterItem\": {\"id\": \"5x4r1669086662773\", \"andOr\": \"and\", \"value\": \"P009\", \"fieldId\": 676, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"CTGt1669086662773\", \"andOr\": \"and\", \"value\": \"肝胆疾病用药\", \"fieldId\": 698, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"t3pf1669086708125\", \"andOr\": \"and\", \"value\": \"苯丙醇软胶囊|三七白及口服液\", \"fieldId\": 682, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"contain\"}}, {\"filterItem\": {\"id\": \"i2fE1669089025719\", \"andOr\": \"and\", \"value\": \"Rx\", \"fieldId\": 678, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"notEqualTo\"}}], \"fatherId\": \"3kX81669086558371\", \"logicalOperator\": \"and\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"isFather\": 1, \"filterItem\": {\"id\": \"jp5F1669086738043\", \"andOr\": \"or\", \"value\": \"P012\", \"fieldId\": 676, \"filters\": [{\"id\": \"pTe61669086755809\", \"filters\": [{\"filterItem\": {\"id\": \"Hxid1669086755809\", \"andOr\": \"and\", \"value\": \"P012\", \"fieldId\": 676, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"TRay1669086755809\", \"andOr\": \"and\", \"value\": \"解热、镇痛、抗炎与抗风湿及抗痛风药\", \"fieldId\": 698, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"NyD21669086782282\", \"andOr\": \"and\", \"value\": \"消旋山莨菪碱片(654-2)\", \"fieldId\": 682, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"pshS1669089039485\", \"andOr\": \"and\", \"value\": \"Rx\", \"fieldId\": 678, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"notEqualTo\"}}], \"fatherId\": \"jp5F1669086738043\", \"logicalOperator\": \"and\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"isFather\": 1, \"filterItem\": {\"id\": \"XnFi1669086899623\", \"andOr\": \"or\", \"value\": \"P028\", \"fieldId\": 676, \"filters\": [{\"id\": \"4wpa1669086908641\", \"filters\": [{\"filterItem\": {\"id\": \"MBcS1669086908641\", \"andOr\": \"and\", \"value\": \"P028\", \"fieldId\": 676, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"hFet1669086908641\", \"andOr\": \"and\", \"value\": \"滋补保健类\", \"fieldId\": 698, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"CHy71669086927039\", \"andOr\": \"and\", \"value\": \"葡萄糖固体饮料|乳糖酶滴剂|乳糖酶水解蛋白调制乳粉|酸性乳糖酶调制乳粉\", \"fieldId\": 682, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"contain\"}}, {\"filterItem\": {\"id\": \"mWF71669089048817\", \"andOr\": \"and\", \"value\": \"Rx\", \"fieldId\": 678, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"notEqualTo\"}}], \"fatherId\": \"XnFi1669086899623\", \"logicalOperator\": \"and\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"isFather\": 1, \"filterItem\": {\"id\": \"QQbD1669086964378\", \"andOr\": \"or\", \"value\": \"P005\", \"fieldId\": 676, \"filters\": [{\"id\": \"3dC51669086975517\", \"filters\": [{\"filterItem\": {\"id\": \"7Qdf1669086975517\", \"andOr\": \"and\", \"value\": \"P005\", \"fieldId\": 676, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"Bh4Q1669086975517\", \"andOr\": \"and\", \"value\": \"胃肠道疾病用药\", \"fieldId\": 698, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"filterItem\": {\"id\": \"A46Q1669086996031\", \"andOr\": \"and\", \"value\": \"清火宝益生元固体饮料|羔羊胃提取物维B12胶囊|盐酸哌仑西平片|铋镁豆蔻片|铋镁碳酸氢钠片|大黄碳酸氢钠片|复方颠茄铋镁片|复方颠茄氢氧化铝片|复方甘铋镁片|复方龙胆碳酸氢钠片|复方芦荟维U片|复方铝酸铋颗粒|复方铝酸铋片|复方木香铝镁片|复方尿囊素片|复方氢氧化铝片|复方维U颠茄铋铝片|复方维生素U胶囊|复方维生素U片|复方胃膜素片|盖胃平片|甘羟铝片|枸橼酸铋钾胶囊|枸橼酸铋钾颗粒|枸橼酸铋钾口服溶液|枸橼酸铋钾片|胶体果胶铋胶囊|胶体酒石酸铋胶囊|硫糖铝分散片|硫糖铝咀嚼片|硫糖铝颗粒|硫糖铝口服混悬液|龙胆碳酸氢钠片|铝镁颠茄片|铝碳酸镁混悬液|铝碳酸镁咀嚼片|铝碳酸镁片|氢氧化铝片|神黄钠铝胶囊|鼠李铋镁片|碳酸钙二甲硅油咀嚼片|碳酸钙甘氨酸胶囊|碳酸氢钠片|维U颠茄铝分散片|维U颠茄铝胶囊|维U颠茄铝胶囊(Ⅱ)|维U颠茄铝镁胶囊|维U颠茄铝镁片|维U颠茄铝镁片(Ⅱ)|金品婴儿清清宝|经典婴儿清清宝|经典幼儿清清宝|优+婴儿清清宝|幼儿清清宝|倍乐舒软胶囊|猴头菇混合片|猴头菇口服液|猴头菇胃肠保健口服液|猴头菇压片糖果|康胃保健口服液|多潘立酮分散片|多潘立酮混悬液|多潘立酮口崩片|多潘立酮片|马来酸多潘立酮片|贝贝开胃宝营养液|促进消化咀嚼片|二甲硅油片|好胃口口服液|开胃消食片|斯唯诺口服液|消食化积口服液|消食片|小儿七星茶固体饮料|优+幼儿清清宝|多酶片|复方胃蛋白酶颗粒|复方消化酶胶囊|复方消化酶胶囊(Ⅱ)|复方胰酶散|胃蛋白酶颗粒|胃蛋白酶口服溶液|胃蛋白酶片|胰酶肠溶胶囊|胰酶肠溶片\", \"fieldId\": 682, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"contain\"}}, {\"filterItem\": {\"id\": \"AmbY1669089059076\", \"andOr\": \"and\", \"value\": \"Rx\", \"fieldId\": 678, \"filters\": null, \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"notEqualTo\"}}], \"fatherId\": \"QQbD1669086964378\", \"logicalOperator\": \"and\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}], \"fatherId\": \"Kt3X1669086456695\", \"logicalOperator\": \"or\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}, {\"isFather\": 1, \"filterItem\": {\"id\": \"fRQG1669086525897\", \"andOr\": \"and\", \"value\": \"P001\", \"fieldId\": 676, \"filters\": [{\"id\": \"xHDy1669087357478\", \"filters\": [], \"fatherId\": \"fRQG1669086525897\", \"logicalOperator\": \"and\"}], \"tableId\": 10020, \"isItself\": 1, \"uniqueId\": 1, \"fieldName\": null, \"fieldAlias\": null, \"otherValue\": null, \"tableAlias\": null, \"functionalOperator\": \"equalTo\"}}], \"logicalOperator\": \"and\"}], \"logicalOperator\": \"\"}";
        TgTemplateInfo info = new TgTemplateInfo();
        info.setDataRangeJson(dataRange);
        TgTemplateInfo applicationInfo = JsonBeanConverter.convert2Obj(info);

        ApplicationSqlBuilder builder = new ApplicationSqlBuilder(null, null, null, null, null);

        builder.setTableInfoService(new TableInfoServiceImpl());

        AtomicReference<String> groupBy = new AtomicReference<>();
        AtomicReference<String> baseTable = new AtomicReference<>();
        builder.setTemplateInfo(applicationInfo);

        String sql = builder.combineTemplateSql(groupBy, baseTable, false);

        log.info("applicationInfo={}", sql);
    }

    @Test
    public void testOld() throws Exception {
        StringBuilder sb = new StringBuilder();
        boolean isReverse = 1 == CommonConstants.ALL_SELECT ? true : false;
        String tempStr = "";
        if (2 == CommonConstants.IN ^ isReverse) {
            tempStr = " GLOBAL IN (";
        } else {
            tempStr = " GLOBAL NOT IN (";
        }
        sb.append(tempStr);
        sb.append("'" + Long.MIN_VALUE + "'");
        sb.append(")");
        System.out.println(sb.toString());
    }
}
